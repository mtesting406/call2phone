/**
*
* Â© 2017 International Services - All rights reserved. ( version: 1.6.3 )
*
*/
function DAROWS(){this._getNextBufferDuration=50,this._analyzeIterations=0,this._silentIterations=0,this._noOfEventsContinue=0,this._noOfEventsStart=0,this._noOfEventsStop=0,this._noOfEventsMax=0,this._noOfEventsMin=0,this._totalNumOfSpeechChunks=0,this._audioDataQueue=[],this._currentSpeechHistory=[],this._currentSpeechLength=0,this._lastAudioLevel=-50,this._currentThreshold=0,this._noSpeechPeriod=0,this._ambientTotal=0,this._ambientAverageLevel=0,this._analysisBufferSize=0,this._noOfAnalysisBuffersPerIteration=0,this._audioInputFrequency=0,this._bufferLengthInSeconds=0,this._speechAllowedDelayChunks=0,this._speechMinimumLengthChunks=0,this._speechMaximumLengthChunks=0,this._getNextBufferIterations=0,this._audioInputEvents=0,this._analysisBufferLengthInS=0,this._speakingRightNow=!1,this._audioContext=null,this._webAudioAPISupported=!1,this._lastErrorCode=DAROWS.ERROR_CODE.NO_ERROR,this._cfg={},this._captureCfg={},this._streamSourceProcessor=null,this._mediaStream=null,this._getUserMediaMode=!1,this._getUserMediaSupported=!1,this._getUserMediaRunning=!1,this._getUserMedia=null,this._audioInputDataTotal=0,this._audioContextSampleRatesCache={}}DAROWS.AUDIO_RESULT_TYPE={WAV_BLOB:1,WEBAUDIO_AUDIOBUFFER:2,RAW_DATA:3,DETECTION_ONLY:4},DAROWS.STATUS={SPEECH_STARTED:1,SPEECH_STOPPED:2,SPEECH_ERROR:3,CAPTURE_STARTED:4,CAPTURE_STOPPED:5,CAPTURE_ERROR:6,ENCODING_ERROR:7,SPEECH_MAX_LENGTH:8,SPEECH_MIN_LENGTH:9},DAROWS.ERROR_CODE={NO_ERROR:0,INVALID_PARAMETER:1,MISSING_PARAMETER:2,NO_WEB_AUDIO_SUPPORT:3,CAPTURE_ALREADY_STARTED:4,AUDIOINPUT_NOT_AVAILABLE:5,RESAMPLING_UNSUPPORTED:6,RESAMPLING_ERROR:7,UNSPECIFIED:999},DAROWS.DEFAULT={SAMPLERATE:16e3,DETECT_ONLY:!1,SPEECH_DETECTION_THRESHOLD:20,SPEECH_DETECTION_ALLOWED_DELAY:200,SPEECH_DETECTION_MIN_LENGTH:10,SPEECH_DETECTION_MAX_LENGTH:6e3,SPEECH_DETECTION_COMPRESS_PAUSES:!1,SPEECH_DETECTION_ANALYSIS_CHUNK_LENGTH:100,AUDIO_RESULT_TYPE:DAROWS.AUDIO_RESULT_TYPE.WAV_BLOB,PREFER_GET_USER_MEDIA:!0,GETUSERMEDIA_ACTIVE:!0,AUDIOINPUT_PLUGIN_ACTIVE:!0,AUDIOSOURCE_TYPE:7,CHANNELS:1,FORMAT:"PCM_16BIT",BUFFER_SIZE:16384,CONCATENATE_MAX_CHUNKS:1,DEBUG_ALERTS:!1,DEBUG_CONSOLE:!1,EXPERIMENTAL:!1},DAROWS.prototype.start=function(e,t,i,r,o){if(this._captureRunning())this._lastErrorCode=DAROWS.ERROR_CODE.CAPTURE_ALREADY_STARTED,this._callSpeechStatusCB(DAROWS.STATUS.CAPTURE_ERROR);else{if(!t)throw this._lastErrorCode=DAROWS.ERROR_CODE.MISSING_PARAMETER,"error: Mandatory parameter 'speechCapturedCB' is missing.";if("function"!=typeof t)throw this._lastErrorCode=DAROWS.ERROR_CODE.INVALID_PARAMETER,"error: Parameter 'speechCapturedCB' must be of type function.";if(i&&"function"!=typeof i)throw this._lastErrorCode=DAROWS.ERROR_CODE.INVALID_PARAMETER,"error: Parameter 'errorCB' must be of type function.";if(r&&"function"!=typeof r)throw this._lastErrorCode=DAROWS.ERROR_CODE.INVALID_PARAMETER,"error: Parameter 'speechStatusCB' must be of type function.";if(e||(e={}),this._cfg={},this._cfg.audioinputPluginActive=e.audioInputPluginActive||DAROWS.DEFAULT.AUDIOINPUT_PLUGIN_ACTIVE,this._cfg.sampleRate=e.sampleRate||DAROWS.DEFAULT.SAMPLERATE,this._cfg.inputSampleRate=e.inputSampleRate||e.sampleRate||DAROWS.DEFAULT.SAMPLERATE,this._cfg.bufferSize=e.bufferSize||DAROWS.DEFAULT.BUFFER_SIZE,this._cfg.audioSourceType=e.audioSourceType||DAROWS.DEFAULT.AUDIOSOURCE_TYPE,this._cfg.concatenateMaxChunks=DAROWS.DEFAULT.CONCATENATE_MAX_CHUNKS,this._cfg.channels=DAROWS.DEFAULT.CHANNELS,this._cfg.format=DAROWS.DEFAULT.FORMAT,this._cfg.speechCapturedCB=t,this._cfg.errorCB=i||null,this._cfg.speechStatusCB=r||null,this._cfg.speechDetectionThreshold=e.speechDetectionThreshold||DAROWS.DEFAULT.SPEECH_DETECTION_THRESHOLD,this._cfg.speechDetectionMinimum=e.speechDetectionMinimum||DAROWS.DEFAULT.SPEECH_DETECTION_MIN_LENGTH,this._cfg.speechDetectionMaximum=e.speechDetectionMaximum||DAROWS.DEFAULT.SPEECH_DETECTION_MAX_LENGTH,this._cfg.speechDetectionAllowedDelay=e.speechDetectionAllowedDelay||DAROWS.DEFAULT.SPEECH_DETECTION_ALLOWED_DELAY,this._cfg.audioResultType=e.audioResultType||DAROWS.DEFAULT.AUDIO_RESULT_TYPE,this._cfg.audioContext=e.audioContext||null,this._cfg.compressPauses=e.compressPauses||DAROWS.DEFAULT.SPEECH_DETECTION_COMPRESS_PAUSES,this._cfg.analysisChunkLength=e.analysisChunkLength||DAROWS.DEFAULT.SPEECH_DETECTION_ANALYSIS_CHUNK_LENGTH,this._cfg.debugAlerts=e.debugAlerts||DAROWS.DEFAULT.DEBUG_ALERTS,this._cfg.debugConsole=e.debugConsole||DAROWS.DEFAULT.DEBUG_CONSOLE,this._cfg.preferGUM=e.preferGUM||DAROWS.DEFAULT.PREFER_GET_USER_MEDIA,this._cfg.getUserMediaActive=DAROWS.DEFAULT.GETUSERMEDIA_ACTIVE,this._cfg.detectOnly=e.detectOnly||DAROWS.DEFAULT.DETECT_ONLY,this._cfg.experimental=e.experimental||DAROWS.DEFAULT.EXPERIMENTAL,this._cfg.detectOnly&&(this._cfg.audioResultType=DAROWS.AUDIO_RESULT_TYPE.DETECTION_ONLY),(this._cfg.audioResultType===DAROWS.AUDIO_RESULT_TYPE.WEBAUDIO_AUDIOBUFFER||this._cfg.preferGUM||!this._cfg.audioinputPluginActive||!window.audioinput)&&!this._initWebAudio(this._cfg.audioContext,this._cfg.preferGUM)&&this._cfg.audioResultType===DAROWS.AUDIO_RESULT_TYPE.WEBAUDIO_AUDIOBUFFER)throw this._lastErrorCode=DAROWS.ERROR_CODE.NO_WEB_AUDIO_SUPPORT,"error: audioResultType is WEBAUDIO_AUDIOBUFFER, but Web Audio not supported on this platform!";if(this._calculateTimePeriods(this._cfg.inputSampleRate,this._cfg.bufferSize),this._resetAll(),this._captureCfg={sampleRate:this._cfg.inputSampleRate,bufferSize:this._cfg.bufferSize,channels:this._cfg.channels,format:this._cfg.format,audioSourceType:this._cfg.audioSourceType,streamToWebAudio:!1},this._getUserMediaMode)this._startMediaStreamSource(o);else{if(!this._cfg.audioinputPluginActive||!window.audioinput)throw this._lastErrorCode=DAROWS.ERROR_CODE.AUDIOINPUT_NOT_AVAILABLE,"error: Nor getUserMedia or cordova-plugin-audioinput are available!";window.removeEventListener("audioinput",this.onAudioInputCapture,!1),window.addEventListener("audioinput",this.onAudioInputCapture,!1),window.removeEventListener("audioinputerror",this.onAudioInputError,!1),window.addEventListener("audioinputerror",this.onAudioInputError,!1),audioinput.start(this._captureCfg),this._getNextBuffer(),this._callSpeechStatusCB(DAROWS.STATUS.CAPTURE_STARTED)}}},DAROWS.prototype.stop=function(){this._cfg.audioinputPluginActive&&window.audioinput&&audioinput.isCapturing()&&audioinput.stop(),this._currentSpeechHistory.length>0&&this._handleAudioBufferCreation(this._currentSpeechHistory),this._captureStopped(),this._resetAll(),this._getUserMediaMode=!1,this._getUserMedia=null,this._mediaStream=null},DAROWS.prototype.isCapturing=function(){return this._captureRunning()},DAROWS.prototype.isSpeakingRightNow=function(){return this._speakingRightNow},DAROWS.prototype.getCfg=function(){return this._cfg},DAROWS.prototype.getCurrentVolume=function(){return this._lastAudioLevel?parseFloat(this._lastAudioLevel).toFixed(0):-1},DAROWS.prototype.getMonitoringData=function(){var e=!1;return this._cfg.audioinputPluginActive&&window.audioinput&&(e=audioinput.isCapturing()),{RealTime:{AmbientAverageLevel:parseFloat(this._ambientAverageLevel).toFixed(0),CurrentLevel:parseFloat(this._lastAudioLevel).toFixed(0),CurrentThreshold:parseFloat(this._currentThreshold).toFixed(0),CurrentSpeechChunks:this._currentSpeechLength,CurrentSpeechBufferSize:this._currentSpeechHistory.length,CurrentSpeechLength:this._noSpeechPeriod,TotalNumOfSpeechChunks:this._totalNumOfSpeechChunks,InputQueueLength:this._audioDataQueue.length,InputDataTotal:this._audioInputDataTotal},Events:{NumOfStart:this._noOfEventsStart,NumOfContinue:this._noOfEventsContinue,NumOfStop:this._noOfEventsStop,NumOfMin:this._noOfEventsMin,NumOfMax:this._noOfEventsMax},GetUserMedia:{Supported:this._getUserMediaSupported,Active:this._getUserMediaMode,CapturingStatus:this._getUserMediaRunning,SampleRate:this._cfg.inputSampleRate},AudioInput:{Active:e,Events:this._audioInputEvents,SampleRate:this._cfg.inputSampleRate},Cfg:this._cfg,Internals:{AnalysisBufferSize:this._analysisBufferSize,AnalysisIterations:this._analyzeIterations,AnalysisBuffersPerIteration:this._noOfAnalysisBuffersPerIteration,AnalysisBufferLengthInS:parseFloat(this._analysisBufferLengthInS).toFixed(3),AudioInputFrequency:this._audioInputFrequency,InputBufferLenInS:parseFloat(this._bufferLengthInSeconds).toFixed(3),MinLengthChunks:this._speechMinimumLengthChunks,MaxLengthChunks:this._speechMaximumLengthChunks,AllowedDelayChunks:this._speechAllowedDelayChunks,GetNextBufferIterations:this._getNextBufferIterations,SampleRate:this._cfg.sampleRate}}},DAROWS.prototype.getAudioContext=function(){return this._audioContext},DAROWS.prototype.activateAudioContext=function(){this._audioContext&&"suspended"===this._audioContext.state&&this._audioContext.resume()},DAROWS.prototype.onAudioInputCapture=function(e){try{this._audioInputEvents++,e&&e.data&&this._audioDataQueue.push(new Float32Array(e.data))}catch(e){this._callErrorCB(e)}},DAROWS.prototype.onAudioInputError=function(e){this._callErrorCB(e)},DAROWS.prototype.getLastErrorCode=function(){return this._lastErrorCode},DAROWS.prototype._calculateTimePeriods=function(e,t){try{this._cfg.bufferSize=t,this._audioInputFrequency=e/t,this._bufferLengthInSeconds=1/this._audioInputFrequency,this._calculateAnalysisBuffers(t,this._bufferLengthInSeconds,this._cfg.analysisChunkLength)}catch(e){this._callErrorCB("_calculateTimePeriods exception: "+e)}},DAROWS.prototype._calculateAnalysisBuffers=function(e,t,i){try{var r=1e3*t;this._noOfAnalysisBuffersPerIteration=Math.ceil(r/i),this._analysisBufferSize=Math.ceil(e/this._noOfAnalysisBuffersPerIteration),this._analysisBufferLengthInS=t/this._noOfAnalysisBuffersPerIteration,this._speechAllowedDelayChunks=Math.round(this._cfg.speechDetectionAllowedDelay/i),this._speechMinimumLengthChunks=Math.round(this._cfg.speechDetectionMinimum/i),this._speechMaximumLengthChunks=Math.round(this._cfg.speechDetectionMaximum/i),this._getNextBufferDuration=i}catch(e){this._callErrorCB("_calculateAnalysisBuffers exception: "+e)}},DAROWS.prototype._callErrorCB=function(e){var t={};e?e.message?t.message=e.message:t.message=e:t.message="An unhandled error has occurred.",this._cfg.errorCB&&this._cfg.errorCB(t),this._showConsoleLog(t.message),this._showAlert(t.message)},DAROWS.prototype._callSpeechCapturedCB=function(e,t){this._cfg.speechCapturedCB?this._cfg.speechCapturedCB(e,this._cfg.audioResultType,t):this._callErrorCB("_callSpeechCapturedCB: No 'speechCapturedCB' callback defined!")},DAROWS.prototype._callSpeechStatusCB=function(e){this._cfg.speechStatusCB&&this._cfg.speechStatusCB(e)},DAROWS.prototype._getNextBuffer=function(){try{if(this._getNextBufferIterations++,this._captureRunning()){var e=this._consumeFromAudioInputQueue();e&&e.length>0&&this._iteratedAndMonitorInputBuffer(e),setTimeout(DAROWS.bindFunction(this,"_getNextBuffer",this._getNextBufferDuration))}else this._speakingRightNow&&this._stopSpeechEvent(this._currentSpeechHistory)}catch(e){this._callErrorCB("_getNextBuffer exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_ERROR),this._resetAll()}},DAROWS.prototype._consumeFromAudioInputQueue=function(){try{var e=new Float32Array(0),t=null;if(this._audioDataQueue.length>0)for(var i=0;i<this._cfg.concatenateMaxChunks&&0!==this._audioDataQueue.length;i++)t=this._audioDataQueue.shift(),this._audioInputDataTotal+=t.length,e=this.float32Concat(e,t);return e}catch(e){this._callErrorCB("_consumeFromAudioInputQueue exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_ERROR),this._resetAll()}},DAROWS.prototype.float32Concat=function(e,t){if(e&&0!==e.length){var i=e.length,r=new Float32Array(i+t.length);return r.set(e),r.set(t,i),r}return t},DAROWS.prototype._iteratedAndMonitorInputBuffer=function(e){try{var t=e.length;t!==this._cfg.bufferSize&&this._calculateTimePeriods(this._cfg.inputSampleRate,t);for(var i=0;i<this._noOfAnalysisBuffersPerIteration;i++){var r=i*this._analysisBufferSize,o=r+this._analysisBufferSize;o>t&&(o=t),this._currentSpeechLength+1>this._speechMaximumLengthChunks&&this._maximumLengthSpeechEvent(this._currentSpeechHistory);var s=e.slice(r,o);this._monitor(s)}}catch(e){this._callErrorCB("_iteratedAndMonitorInputBuffer exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_ERROR)}},DAROWS.prototype._monitor=function(e){try{this._identifySpeech(e)?this._speakingRightNow?this._continueSpeechEvent(e,!1):this._startSpeechEvent(e):(this._speakingRightNow&&(this._noSpeechPeriod++,this._noSpeechPeriod>this._speechAllowedDelayChunks?this._stopSpeechEvent(this._currentSpeechHistory):this._cfg.compressPauses||this._continueSpeechEvent(e,!0)),this._calculateAmbientAverageLevel(this._lastAudioLevel))}catch(e){this._callErrorCB("_monitor exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_ERROR),this._resetAll()}},DAROWS.prototype._identifySpeech=function(e){try{if(e&&e.length>0){this._analyzeIterations++;var t=this._getAudioLevels(e);if(t!==-1/0&&(this._lastAudioLevel=t,this._lastAudioLevel>this._currentThreshold))return this._totalNumOfSpeechChunks++,!0}}catch(e){this._callErrorCB("_identifySpeech exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_ERROR)}return!1},DAROWS.prototype._calculateAmbientAverageLevel=function(e){this._silentIterations++,this._ambientTotal=this._ambientTotal+e,this._ambientAverageLevel=this._ambientTotal/this._silentIterations,this._currentThreshold=this._ambientAverageLevel+this._cfg.speechDetectionThreshold,this._currentThreshold=this._currentThreshold>0?0:this._currentThreshold},DAROWS.prototype._getAudioLevels=function(e){try{for(var t,i,r=0,o=e.length,s=0;s<o;s++)r+=(i=Math.abs(e[s]))*i;return t=Math.sqrt(r/o),this._getDecibelFromAmplitude(t)}catch(e){this._callErrorCB("_getAudioLevels exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_ERROR)}return null},DAROWS.prototype._getDecibelFromAmplitude=function(e){return Math.log(e)/Math.log(10)*20},DAROWS.prototype._resetAll=function(){this._speakingRightNow=!1,this._resetAudioInputQueue(),this._resetSpeechDetection(),this._resetAmbientLevels(),this._noOfEventsContinue=0,this._noOfEventsStart=0,this._noOfEventsStop=0,this._noOfEventsMax=0,this._noOfEventsMin=0,this._totalNumOfSpeechChunks=0,this._audioInputEvents=0,this._analyzeIterations=0,this._getNextBufferIterations=0,this._lastAudioLevel=-50,this._currentThreshold=0,this._audioInputDataTotal=0},DAROWS.prototype._resetAmbientLevels=function(){this._ambientTotal=0,this._ambientAverageLevel=0,this._silentIterations=0},DAROWS.prototype._resetAudioInputQueue=function(){this._audioDataQueue=[]},DAROWS.prototype._resetSpeechDetection=function(e){e?(this._currentSpeechHistory=e,this._currentSpeechLength=1):(this._currentSpeechHistory=new Float32Array(0),this._currentSpeechLength=0),this._noSpeechPeriod=0},DAROWS.prototype._stopSpeech=function(){this._speakingRightNow=!1,this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_STOPPED)},DAROWS.prototype._startSpeech=function(){this._speakingRightNow=!0,this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_STARTED)},DAROWS.prototype._startSpeechEvent=function(e){this._noOfEventsStart++,this._startSpeech(),this._resetSpeechDetection(),this._continueSpeechEvent(e,!1)},DAROWS.prototype._continueSpeechEvent=function(e,t){this._noOfEventsContinue++,this._appendSpeechToHistory(e),t||(this._noSpeechPeriod=0)},DAROWS.prototype._maximumLengthSpeechEvent=function(e){var t,i,r;this._noOfEventsMax++,this._cfg.experimental&&(t=this._splitSpeechOnLastSilence(e)),i=e,r=null,t&&(i=t[0],r=t[1]),this._stopSpeechEvent(i,r),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_MAX_LENGTH)},DAROWS.prototype._splitSpeechOnLastSilence=function(e){return this._getFirstSilenceFromTheEnd(e)},DAROWS.prototype._getFirstSilenceFromTheEnd=function(e){try{for(var t=0,i=e.length,r=0,o=0,s=Math.floor(e.length/100*15),a=Math.floor(s/300),n=0,u=null,h=0,c=Math.floor(s/a),_=i;_>0;_--)if(t+=(o=Math.abs(e[_]))*o,++n>=a||_<a-n){if(r=Math.sqrt(t/a),t=0,n=0,this._getDecibelFromAmplitude(r)>-this._cfg.speechDetectionThreshold){(u=[]).push(e.slice(0,_)),u.push(e.slice(_));break}if(++h>c)break}return u||console.warn("Didn't find any parts: "+h,this._currentThreshold),u}catch(e){this._callErrorCB("_getFirstSilenceFromTheEnd exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_ERROR)}return null},DAROWS.prototype._stopSpeechEvent=function(e,t){this._noOfEventsStop++,this._handleAudioBufferCreation(e),this._stopSpeech(),this._resetSpeechDetection(t)},DAROWS.prototype._appendSpeechToHistory=function(e){this._cfg.detectOnly||(this._currentSpeechHistory=this.float32Concat(this._currentSpeechHistory,e)),this._currentSpeechLength++},DAROWS.prototype._handleAudioBufferCreation=function(e){if(this._currentSpeechLength>this._speechMinimumLengthChunks){var t=e.slice(0);switch(this._cfg.audioResultType){case DAROWS.AUDIO_RESULT_TYPE.WEBAUDIO_AUDIOBUFFER:this._createWebAudioBuffer(t);break;case DAROWS.AUDIO_RESULT_TYPE.RAW_DATA:this._callSpeechCapturedCB(t,{length:e.length});break;case DAROWS.AUDIO_RESULT_TYPE.DETECTION_ONLY:break;default:case DAROWS.AUDIO_RESULT_TYPE.WAV_BLOB:this._createWAVAudioBuffer(t)}}else this._noOfEventsMin++,this._callSpeechStatusCB(DAROWS.STATUS.SPEECH_MIN_LENGTH)},DAROWS.prototype._createWAVAudioBuffer=function(e){try{this._showConsoleLog("_createWAVAudioBuffer: "+e.length);var t=this,i=function(e){try{var i=null,r=e.sampleRate;if(1===t._cfg.channels)i=e.getChannelData(0);else{if(2!==t._cfg.channels)return t._callErrorCB("_createWAVAudioBuffer doesn't support more than two (2) channels!"),void t._callSpeechStatusCB(DAROWS.STATUS.ENCODING_ERROR);i=wavEncoder.interleave(e.getChannelData(0),e.getChannelData(1))}var o=wavEncoder.encode(i,r,t._cfg.channels);t._callSpeechCapturedCB(new Blob([o],{type:"audio/wav"}),{length:i.length})}catch(e){t._callErrorCB("_createWAVAudioBuffer (with resampling) exception: "+e),t._callSpeechStatusCB(DAROWS.STATUS.ENCODING_ERROR)}},r=null,o=this._cfg.inputSampleRate;this._webAudioAPISupported&&(o=(r=this._createAudioBufferFromRawData(e)).sampleRate),o!==this._cfg.sampleRate?this._webAudioAPISupported?this._checkIfSampleRateIsValidForOfflineAudioContext(this._cfg.sampleRate)?ReSampler.resampleAudioBuffer(r,this._cfg.sampleRate,i,this._callErrorCB.bind(this)):i(r):(this._callErrorCB("_createWAVAudioBuffer (with resampling) failed since Web Audio API isn't supported. Remove the 'samplerate' from the start configuration in order to use the default samplerate of the platform and avoid this error."),this._callSpeechStatusCB(DAROWS.STATUS.RESAMPLING_UNSUPPORTED)):function(e){try{var i=wavEncoder.encode(e,t._cfg.sampleRate,t._cfg.channels),r=new Blob([i],{type:"audio/wav"});t._callSpeechCapturedCB(r,{length:e.length})}catch(e){t._callErrorCB("_createWAVAudioBuffer exception (EncodeRawAudioBufferToWAVDataAndCallCB): "+e),t._callSpeechStatusCB(DAROWS.STATUS.ENCODING_ERROR)}}(e)}catch(e){this._callErrorCB("_createWAVAudioBuffer exception (outer): "+e),this._callSpeechStatusCB(DAROWS.STATUS.ENCODING_ERROR)}},DAROWS.prototype._createWebAudioBuffer=function(e){try{this._showConsoleLog("_createWebAudioBuffer: "+e.length);var t=this._createAudioBufferFromRawData(e);if(t.inputSampleRate!==this._cfg.sampleRate)try{this._showConsoleLog("_createWebAudioBuffer - Resample audio from "+this._cfg.inputSampleRate+" to "+this._cfg.sampleRate+": "+e.length),ReSampler.resampleAudioBuffer(t,this._cfg.sampleRate,this._callSpeechCapturedCB.bind(this),this._callErrorCB.bind(this))}catch(e){this._callErrorCB("_createWebAudioBuffer resampling exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.RESAMPLING_ERROR)}else this._callSpeechCapturedCB(t,{length:e.length,duration:t.duration})}catch(e){this._callErrorCB("_createWebAudioBuffer exception: "+e),this._callSpeechStatusCB(DAROWS.STATUS.ENCODING_ERROR)}},DAROWS.prototype._createAudioBufferFromRawData=function(e){var t=this.getAudioContext().createBuffer(this._captureCfg.channels,e.length/this._captureCfg.channels,this._cfg.inputSampleRate);if(this._captureCfg.channels>1)for(var i=0;i<this._captureCfg.channels;i++){for(var r=[],o=0;o<e.length;)r.push(e[o+i]),o+=parseInt(this._captureCfg.channels);t.getChannelData(i).set(new Float32Array(r))}else t.getChannelData(0).set(e);return t},DAROWS.prototype._initWebAudio=function(e,t){try{return this._webAudioAPISupported=!1,window.AudioContext=window.AudioContext||window.webkitAudioContext,e?(this._showConsoleLog("Using Audio Context provided in cfg."),this._audioContext=e,this._webAudioAPISupported=!0):this._audioContext?this._audioContext&&(this._webAudioAPISupported=!0):(this._showConsoleLog("Creating new Audio Context."),this._audioContext=new window.AudioContext,this._webAudioAPISupported=!0),navigator.mediaDevices&&(this._showConsoleLog("navigator.mediaDevices found"),navigator.mediaDevices.getUserMedia&&(this._showConsoleLog("navigator.mediaDevices.getUserMedia found"),this._getUserMedia=navigator.mediaDevices.getUserMedia)),this._getUserMedia||(this._getUserMedia=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia).bind(navigator)),this._getUserMedia?(this._getUserMediaSupported=!0,!t&&_cfg.audioinputPluginActive&&window.audioinput||(this._getUserMediaMode=!0,this._cfg.inputSampleRate=this._audioContext.sampleRate,this._showConsoleLog("The current Web Audio Context samplerate is: "+this._cfg.inputSampleRate))):this._showConsoleLog("Neither navigator.(webkit)getUserMedia or navigator.mediaDevices.getUserMedia is supported on this platform."),!0}catch(e){return!1}},DAROWS.prototype._startMediaStreamSource=function(e){var t=this;if(!this._getUserMedia||!this._getUserMediaMode)throw"error: GetUserMedia is not supported!";try{e?(this._mediaStream=this._audioContext.createMediaStreamSource(e),this._streamSourceProcessor=this._audioContext.createScriptProcessor(this._cfg.bufferSize,1,1),this._streamSourceProcessor.onaudioprocess=function(e){if(t._getUserMediaRunning)try{t._audioInputEvents++,t._audioDataQueue.push(new Float32Array(e.inputBuffer.getChannelData(0)))}catch(e){t._captureStopped(),t._callErrorCB("_startMediaStreamSource (MediaDevices).onaudioprocess exception: "+e)}},this._mediaStream.connect(this._streamSourceProcessor),this._streamSourceProcessor.connect(this._audioContext.destination),this._captureStarted(),this._getNextBuffer()):navigator.mediaDevices?navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){try{t._mediaStream=t._audioContext.createMediaStreamSource(e),t._streamSourceProcessor=t._audioContext.createScriptProcessor(t._cfg.bufferSize,1,1),t._streamSourceProcessor.onaudioprocess=function(e){if(t._getUserMediaRunning)try{t._audioInputEvents++,t._audioDataQueue.push(new Float32Array(e.inputBuffer.getChannelData(0)))}catch(e){t._captureStopped(),t._callErrorCB("_startMediaStreamSource (MediaDevices).onaudioprocess exception: "+e)}},t._mediaStream.connect(t._streamSourceProcessor),t._streamSourceProcessor.connect(t._audioContext.destination),t._captureStarted(),t._getNextBuffer()}catch(e){t._cfg.debugConsole&&console.error("_startMediaStreamSource getUserMedia (MediaDevices) exception: "+e),t._callErrorCB("_startMediaStreamSource getUserMedia (MediaDevices) exception: "+e),t._captureStopped()}}).catch(function(e){t._cfg.debugConsole&&console.error("_startMediaStreamSource getUserMedia (MediaDevices) - Failed to get MediaStream: "+e),t._callErrorCB("_startMediaStreamSource getUserMedia (MediaDevices) - Failed to get MediaStream: "+e),t._captureStopped()}):this._getUserMedia({video:!1,audio:!0},function(e){try{t._mediaStream=t._audioContext.createMediaStreamSource(e),t._streamSourceProcessor=t._audioContext.createScriptProcessor(t._cfg.bufferSize,1,1),t._streamSourceProcessor.onaudioprocess=function(e){if(t._getUserMediaRunning)try{t._audioInputEvents++,t._audioDataQueue.push(new Float32Array(e.inputBuffer.getChannelData(0)))}catch(e){t._captureStopped(),t._callErrorCB("_startMediaStreamSource.onaudioprocess exception: "+e)}},t._mediaStream.connect(this._streamSourceProcessor),t._streamSourceProcessor.connect(this._audioContext.destination),t._captureStarted(),t._getNextBuffer()}catch(e){t._cfg.debugConsole&&console.error("_startMediaStreamSource getUserMedia exception: "+e),t._callErrorCB("_startMediaStreamSource getUserMedia exception: "+e),t._captureStopped()}},function(e){t._cfg.debugConsole&&console.error("_startMediaStreamSource - Failed to get MediaStream: "+e),t._callErrorCB("_startMediaStreamSource - Failed to get MediaStream: "+JSON.stringify(e,null,4)),t._captureStopped()})}catch(e){this._cfg.debugConsole&&console.error("_startMediaStreamSource exception: "+e),this._callErrorCB("_startMediaStreamSource exception: "+e),this._captureStopped()}},DAROWS.prototype._captureStopped=function(){this._getUserMediaMode&&(this._getUserMediaRunning=!1,this._streamSourceProcessor&&(this._streamSourceProcessor.onaudioprocess=null),this._streamSourceProcessor=null,this._callSpeechStatusCB(DAROWS.STATUS.CAPTURE_STOPPED))},DAROWS.prototype._captureStarted=function(){this._getUserMediaMode&&(this._getUserMediaRunning=!0),this._callSpeechStatusCB(DAROWS.STATUS.CAPTURE_STARTED)},DAROWS.prototype._captureRunning=function(){return this._getUserMediaMode?this._getUserMediaRunning:!(!this._cfg.audioinputPluginActive||!window.audioinput)&&audioinput.isCapturing()},DAROWS.prototype._checkIfSampleRateIsValidForOfflineAudioContext=function(e){if(this._audioContextSampleRatesCache.hasOwnProperty(e))return this._audioContextSampleRatesCache[e];var t=window.OfflineAudioContext||window.webkitOfflineAudioContext,i=!0;try{new t(1,e,e)}catch(e){i=!1}return this._audioContextSampleRatesCache[e]=i,i},DAROWS.prototype._showAlert=function(e){this._cfg.debugAlerts&&e&&alert(e)},DAROWS.prototype._showConsoleLog=function(e){this._cfg.debugConsole&&e&&console.log(e)},DAROWS.bindFunction=function(e,t){return function(){return e[t].apply(e,arguments)}},Float32Array.prototype.slice||(Float32Array.prototype.slice=function(e,t){t||(t=this.length);for(var i=new Float32Array(t-e),r=0;r<e+t;++r)i[r]=this[e+r];return i});var ReSampler={resampleAudioBuffer:function(e,t,i,r){try{var o=e.numberOfChannels,s=Math.round(e.length*(t/e.sampleRate)),a=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(o,s,t),n=a.createBufferSource();n.buffer=e,a.oncomplete=function(t){try{var o=t.renderedBuffer;i&&"function"==typeof i&&i(o,{length:e.length,duration:o.duration})}catch(e){r&&"function"==typeof r&&r("ReSampler.resampleAudioBuffer offlineContext_.oncomplete exception: "+e)}},n.connect(a.destination),n.start(0),a.startRendering()}catch(e){r&&"function"==typeof r&&r("Failed to resample audio to sampleRate "+t+": "+e)}}},wavEncoder=function(){var e=function(e,t,i){for(var r=0;r<i.length;r++)e.setUint8(t+r,i.charCodeAt(r))},t=function(e,t,i){for(var r=0;r<i.length;r++,t+=2){var o=Math.max(-1,Math.min(1,i[r]));e.setInt16(t,o<0?32768*o:32767*o,!0)}};return{encode:function(i,r,o){var s=o||1,a=2*s,n=r*a,u=i.length*a,h=new ArrayBuffer(44+u),c=new DataView(h);return e(c,0,"RIFF"),c.setUint32(4,32+u,!0),e(c,8,"WAVE"),e(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,1,!0),c.setUint16(22,s,!0),c.setUint32(24,r,!0),c.setUint32(28,n,!0),c.setUint16(32,a,!0),c.setUint16(34,16,!0),e(c,36,"data"),c.setUint32(40,u,!0),t(c,44,i),c},interleave:function(e,t){for(var i=e.length+t.length,r=new Float32Array(i),o=0,s=0;o<i;)r[o++]=e[s],r[o++]=t[s],s++;return r}}}();